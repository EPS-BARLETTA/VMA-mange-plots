<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Bilan ‚Äî Mange Plots</title>

  <!-- Tailwind + ton CSS existant (inchang√©) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"/>
  <link rel="stylesheet" href="./app.css"/>

  <!-- ‚ö†Ô∏è Lib QR d√©j√† utilis√©e dans ton app (inchang√©e) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <!-- Styles non destructifs (inchang√©s) -->
  <style>
    :root{
      --blue-100:#dbeafe; --blue-200:#bfdbfe; --blue-700:#1d4ed8;
      --green-100:#dcfce7; --green-200:#bbf7d0; --green-700:#15803d;
      --border:#e5e7eb; --text:#0f172a; --muted:#64748b; --white:#fff;
    }
    #recapTables > * { border:1px solid var(--border); border-radius:14px; padding:12px; overflow:auto; }
    #recapTables > *:nth-child(1){ background:var(--blue-100); }
    #recapTables > *:nth-child(2){ background:var(--green-100); }

    #recapTables table{ width:100%; border-collapse:separate; border-spacing:0; }
    #recapTables th{
      position:sticky; top:0; background:rgba(255,255,255,.6); backdrop-filter:saturate(1.2);
      text-align:left; font-weight:800; color:var(--text); border-bottom:2px solid var(--border);
      padding:10px 12px;
    }
    #recapTables td{ padding:10px 12px; border-bottom:1px solid var(--border); color:var(--text); }
    #recapTables tr:nth-child(even) td{ background:rgba(255,255,255,.35); }
    #recapTables tr:last-child td{ border-bottom:0; }

    #qrButtons{ margin-top:4px; }
    #qrButtons button{
      display:block; width:100%; padding:.85rem 1rem; font-weight:800; border-radius:12px;
      border:1px solid var(--border); color:var(--text); background:var(--blue-100);
      transition:transform .04s ease;
    }
    #qrButtons button:active{ transform:translateY(1px); }
    #qrButtons > *:nth-child(even) button{ background:var(--green-100); border-color:var(--green-200); }
    #qrButtons > *:nth-child(odd)  button{ background:var(--blue-100);  border-color:var(--blue-200); }

    #qrModal.modal{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.35); padding:16px; z-index:50;
    }
    #qrModal.modal.active{ display:flex; }
    #qrModal .qrBox{
      background:var(--white); border:1px solid var(--border); border-radius:16px;
      padding:16px; box-shadow:0 10px 40px rgba(0,0,0,.15);
      max-width:90vw; max-height:90vh; overflow:auto;
    }
    #qrModal .close{
      position:absolute; top:18px; right:18px; background:var(--white); color:var(--text);
      border:1px solid var(--border); border-radius:999px; padding:.45rem .75rem; font-weight:800;
    }
  </style>
</head>
<body>
  <header class="max-w-6xl mx-auto p-4 flex justify-between items-center border-b-2 border-gray-200">
    <a href="./index.html" class="btn btn-ghost">Accueil</a>
    <div class="text-sm">Bilan & QR (√† la demande)</div>
  </header>

  <main class="max-w-6xl mx-auto p-4 space-y-6">
    <h1 class="text-3xl font-extrabold">Bilan de la s√©ance</h1>

    <!-- Tableau r√©cap en premier -->
    <section class="card">
      <h2 class="text-xl font-bold mb-3">R√©capitulatif</h2>
      <div id="recapTables" class="space-y-6"></div>
    </section>

    <!-- Boutons QR par √©l√®ve (remplis automatiquement) -->
    <section id="qrButtons" class="grid md:grid-cols-2 gap-4"></section>

    <!-- Conteneur QR compact (cach√©) requis par ScanProf -->
    <div id="qrBox" class="hidden"></div>
  </main>

  <!-- Modale QR (fond blanc, grand QR) -->
  <div id="qrModal" class="modal">
    <button class="close" id="closeModal">Fermer</button>
    <div class="qrBox">
      <div id="qrFull" style="width:640px;height:640px;"></div>
    </div>
  </div>

  <footer class="text-center py-6 border-t-2 border-gray-200">
    <div>Mange Plots ‚Äî √âquipe EPS Lyc√©e Vauban ‚Äî LUXEMBOURG ‚Äî JB</div>
  </footer>

  <!-- Tes helpers -->
  <script src="./app.js"></script>

  <!-- Helpers ScanProf (inline : pas d‚Äôappel externe, respecte MDM) -->
  <script>
  (function () {
    function stripAccents(s){return (s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"");}
    function toFixedNum(v,d){const n=Number(v);return isFinite(n)?Number(n.toFixed(d)):0;}
    function toInt(v){const n=parseInt(String(v??"").trim(),10);return Number.isFinite(n)?n:0;}

    // 4√®me/4eme/4e/4 a -> 4A
    function normalizeClasse(raw){
      let s = stripAccents(String(raw||"")).toUpperCase().replace(/\s+/g,"");
      s = s.replace(/EME/g,"E");
      const m = s.match(/(\d{1,2})\s*([A-Z])/);
      if(m) return `${m[1]}${m[2]}`;
      const n = s.match(/(\d{1,2})/);
      return n ? `${n[1]}` : s;
    }

    // mappe 1 √©l√®ve -> format ScanProf (+ extras)
    function mapOne(raw, keepExtras){
      const o = {...(raw||{})};
      const nom = String(o.nom||o.name||o.Nom||"").toUpperCase().trim();
      const prenom = String(o.prenom||o.Prenom||o.firstName||"").trim();
      const classe = normalizeClasse(o.classe||o.Classe||o.class||o["classe_eleve"]);
      let sexe = String(o.sexe||o.Sexe||o.gender||"").trim().toUpperCase();
      sexe = sexe.startsWith("M")?"M":(sexe.startsWith("F")?"F":"");
      const distance = toInt(o.distance ?? o.m ?? o["distance_m"]);
      const vitesse  = toFixedNum(o.vitesse ?? o.speed ?? 0, 2);
      const leds = {};
      for(let i=0;i<=5;i++){ leds[`nb_led_${i}`] = toInt(o[`nb_led_${i}`] ?? o[`led_${i}`] ?? 0); }
      const indice_tir = toFixedNum(o.indice_tir ?? o["indiceTir"] ?? 0, 2);

      let extras;
      if(keepExtras){
        const white = new Set(["nom","name","Nom","prenom","Prenom","firstName","classe","Classe","class","classe_eleve","sexe","Sexe","gender","distance","m","distance_m","vitesse","speed","indice_tir","indiceTir","nb_led_0","nb_led_1","nb_led_2","nb_led_3","nb_led_4","nb_led_5","led_0","led_1","led_2","led_3","led_4","led_5"]);
        extras = {};
        Object.keys(o).forEach(k=>{ if(!white.has(k)) extras[k]=o[k]; });
        if(Object.keys(extras).length===0) extras=undefined;
      }

      return {
        nom, prenom, classe, sexe, distance, vitesse,
        nb_led_0: leds.nb_led_0, nb_led_1: leds.nb_led_1, nb_led_2: leds.nb_led_2,
        nb_led_3: leds.nb_led_3, nb_led_4: leds.nb_led_4, nb_led_5: leds.nb_led_5,
        indice_tir,
        ...(extras?{extras}:{})
      };
    }

    // G√©n√®re le QR dans un conteneur donn√© (utilise qrcodejs d√©j√† charg√©e)
    function makeScanProfQR(rows, targetId, opts){
      const el = document.getElementById(targetId);
      if(!el) return console.error("[ScanProf] conteneur introuvable:", targetId);
      el.innerHTML = "";
      const keepExtras = !!(opts && opts.keepExtras);
      const list = Array.isArray(rows)? rows : [rows];
      const payload = JSON.stringify(list.map(r => mapOne(r, keepExtras)));
      const size = (opts && opts.width) || 256;
      new QRCode(el, { text: payload, width: size, height: size, correctLevel: QRCode.CorrectLevel.M });
      return payload;
    }

    // UI : boutons + modale + QR compact cach√©
    function renderScanProfUI(rows){
      const list  = Array.isArray(rows)? rows : [rows];
      const btns  = document.getElementById("qrButtons");
      const modal = document.getElementById("qrModal");
      const full  = document.getElementById("qrFull");
      const close = document.getElementById("closeModal");
      if(!btns || !modal || !full || !close){ console.warn("[ScanProf] UI manquante."); return; }
      btns.innerHTML = "";
      list.forEach((raw, i)=>{
        const mapped = mapOne(raw, true);
        const wrap = document.createElement("div");
        const b = document.createElement("button");
        const label = `${mapped.prenom||""} ${mapped.nom||""} ‚Äî ${mapped.classe||""}`.trim();
        b.textContent = `üì± QR ‚Ä¢ ${label || ("√âl√®ve "+(i+1))}`;
        b.addEventListener("click", ()=>{
          full.innerHTML = "";
          makeScanProfQR([raw], "qrFull", { width:640, keepExtras:true });
          modal.classList.add("active");
        });
        wrap.appendChild(b);
        btns.appendChild(wrap);
      });
      close.addEventListener("click", ()=> modal.classList.remove("active"));
      modal.addEventListener("click", (e)=>{ if(e.target===modal) modal.classList.remove("active"); });

      // QR compact cach√© (multi-√©l√®ves) ‚Äî utile si t√©l√©chargement plus tard
      try{ makeScanProfQR(list, "qrBox", { width:256, keepExtras:true }); }catch(e){}
    }

    // Expose pour le script d'init plus bas
    window.renderScanProfUI = renderScanProfUI;
  })();
  </script>

  <!-- Ton script r√©cap (inchang√©) -->
  <script src="./recap.js"></script>

  <!-- INIT : sans toucher recap.js ‚Äî r√©cup√®re la liste depuis variables globales ou localStorage -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    let data = window.eleves || window.rows || window.liste;
    if (!Array.isArray(data) || !data.length) {
      try {
        const raw = localStorage.getItem('eleves')
          || localStorage.getItem('participants')
          || localStorage.getItem('mangeplots_eleve')
          || '[]';
        data = JSON.parse(raw);
      } catch(e) { data = []; }
    }
    if (Array.isArray(data) && data.length) {
      window.renderScanProfUI(data);
    } else {
      console.warn('Aucune donn√©e √©l√®ve d√©tect√©e pour le QR.');
    }
  });
  </script>
</body>
</html>
