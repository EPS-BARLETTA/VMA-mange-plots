const $=e=>document.querySelector(e),runners=loadJSON(KEY_RUNNERS,null),plan=loadJSON(KEY_PLAN,[]),results=loadJSON(KEY_RESULTS,[]);if(!runners||0===plan.length){alert("Paramétrage manquant. Retour à l'accueil."),location.href="./setup.html"}document.getElementById("nameA").textContent=`${runners.A?.prenom||""} ${runners.A?.nom||""}`,document.getElementById("nameB").textContent=`${runners.B?.prenom||""} ${runners.B?.nom||""}`;let blocIndex=0,subIndex=0,running=!1,timerInterval=null,elapsed=0,subElapsed=0;const subTarget=90;let subPlots=0;const THEME_COLORS=["#2563eb","#059669","#7c3aed","#f59e0b","#ef4444","#14b8a6"];function applyThemeColor(e){const t=THEME_COLORS[e%THEME_COLORS.length];document.getElementById("themeStripe").style.background=t}const elBlocTitle=$("#blocTitle"),elRunnerName=$("#runnerName"),elTimer=$("#timer"),elSubLeft=$("#subLeft"),elSubBar=$("#subBar"),elKpiVitesse=$("#kpiVitesse"),elKpiPlots=$("#kpiPlots"),elKpiTol=$("#kpiTol"),elCounter=$("#counter"),elFeedback=$("#feedback"),elRunnerBadge=$("#runnerBadge"),elSubLog=$("#subLog"),elTbodyResults=$("#tbodyResults");let blocRunLog=[];function currentBloc(){return plan[blocIndex]}function currentRunnerForBloc(){const e=currentBloc();return"A"===e.runner?"A":"B"===e.runner?"B":subIndex%2==0?"A":"B"}function refreshUI(){const e=currentBloc(),t=currentRunnerForBloc(),n=runners[t],o=speedTarget(n.vma,e.pctVMA),a=plotsPer90FromSpeed(o);elBlocTitle.textContent=`Bloc ${blocIndex+1}/${plan.length} — ${e.duree} @ ${e.pctVMA}%`,elRunnerName.innerHTML=`<span class="badge badge-active">${"A"===t?"Coureur A":"Coureur B"}</span> ${n.prenom} ${n.nom}`,elKpiVitesse.textContent=o.toFixed(1),elKpiPlots.textContent=String(a),elKpiTol.textContent=String(computeTolerancePlots());const r=Math.max(0,mmssToSeconds(e.duree)-elapsed);elTimer.textContent=secondsToMMSS(r),elSubLeft.textContent=secondsToMMSS(Math.max(0,90-subElapsed)),elSubBar.style.width=`${Math.min(100,subElapsed/90*100)}%`,elCounter.textContent=String(subPlots);const l=subPlots-a;Math.abs(l)<=1?elFeedback.innerHTML=`<span class="badge badge-ok">OK (${l>=0?"+":""}${l})</span>`:2===Math.abs(l)?elFeedback.innerHTML=`<span class="badge badge-warn">${l>=0?"+":""}${l} plot(s)</span>`:elFeedback.innerHTML=`<span class="badge badge-err">${l>=0?"+":""}${l} plot(s)</span>`,elRunnerBadge.textContent=running?"En cours":"En pause",elRunnerBadge.className="badge "+(running?"badge-ok":"badge-warn")}function pushSubLog(){const e=currentBloc(),t=currentRunnerForBloc(),n=runners[t],o=speedTarget(n.vma,e.pctVMA),a=plotsPer90FromSpeed(o),r=subPlots-a,l=document.createElement("li");l.textContent=`Bloc ${blocIndex+1}.${subIndex+1} — ${n.prenom} ${n.nom} : ${subPlots} plots (cible ${a}, diff ${r>=0?"+":""}${r})`,elSubLog.appendChild(l),elSubLog.scrollTop=elSubLog.scrollHeight}function finalizeBloc(){const e=currentBloc();["A","B"].forEach((t=>{const n=blocRunLog.filter((n=>n.blocIndex===blocIndex&&n.runnerKey===t));if(!n.length)return;const o=runners[t],a=n.reduce(((e,t)=>e+t.subPlots),0)/n.length,r=n.reduce(((e,t)=>e+t.subPlots),0),l=Math.round(n.reduce(((e,t)=>e+(t.subPlots-t.plotsCible)),0)*10)/10,s=Number(.5*l.toFixed(1)),c=90*n.length,d=12.5*r,u=Number((d/c*3.6).toFixed(1)),i={nom:o.nom,prenom:o.prenom,classe:o.classe,vma:o.vma,duree:e.duree,pctVMA:e.pctVMA,vitesse_cible:speedTarget(o.vma,e.pctVMA).toFixed(1),plots_cible_90s:plotsPer90FromSpeed(speedTarget(o.vma,e.pctVMA)),plots_moy_90s:Math.round(10*a)/10,ecart_plots_total:l,ecart_kmh:s,distance_m:Math.round(d),vitesse_moy_kmh:u};results.push(i)})),saveJSON(KEY_RESULTS,results),renderResults()}function stepTick(){if(elapsed++,subElapsed++,subElapsed>=90){const e=currentBloc(),t=currentRunnerForBloc(),n=runners[t],o=speedTarget(n.vma,e.pctVMA),a=plotsPer90FromSpeed(o);if(blocRunLog.push({blocIndex:blocIndex,runnerKey:t,subPlots:subPlots,plotsCible:a}),pushSubLog(),subIndex++,subElapsed=0,subPlots=0,subIndex>=e.blocks90){if(finalizeBloc(),blocIndex++,blocIndex>=plan.length)return clearInterval(timerInterval),timerInterval=null,running=!1,refreshUI(),void alert("Séance terminée ✅");applyThemeColor(blocIndex),elapsed=0,subElapsed=0,subIndex=0,subPlots=0}}refreshUI()}function renderResults(){elTbodyResults.innerHTML="",results.forEach((e=>{const t=document.createElement("tr");t.innerHTML=`<td>${e.prenom} ${e.nom}</td><td>${e.duree}</td><td>${e.pctVMA}%</td><td>${e.plots_moy_90s}</td><td>${e.ecart_kmh} km/h</td>`,elTbodyResults.appendChild(t)}))}function initBloc(){elapsed=0,subElapsed=0,subIndex=0,subPlots=0,applyThemeColor(0),refreshUI()}document.getElementById("btnStart").addEventListener("click",(()=>{running||(running=!0,timerInterval&&clearInterval(timerInterval),timerInterval=setInterval(stepTick,1e3),refreshUI())})),document.getElementById("btnPause").addEventListener("click",(()=>{running=!1,timerInterval&&(clearInterval(timerInterval),timerInterval=null),refreshUI()})),document.getElementById("btnNext").addEventListener("click",(()=>{const e=currentBloc(),t=currentRunnerForBloc(),n=runners[t],o=speedTarget(n.vma,e.pctVMA),a=plotsPer90FromSpeed(o);if(blocRunLog.push({blocIndex:blocIndex,runnerKey:t,subPlots:subPlots,plotsCible:a}),pushSubLog(),subIndex++,subElapsed=0,subPlots=0,subIndex>=e.blocks90){if(finalizeBloc(),blocIndex++,blocIndex>=plan.length)return timerInterval&&clearInterval(timerInterval),timerInterval=null,running=!1,refreshUI(),void alert("Séance terminée ✅");applyThemeColor(blocIndex),elapsed=0,subElapsed=0,subIndex=0,subPlots=0}refreshUI()})),document.getElementById("btnPlus").addEventListener("click",(()=>{subPlots+=1,refreshUI()})),document.getElementById("btnMinus").addEventListener("click",(()=>{subPlots>0&&(subPlots-=1,refreshUI())})),document.getElementById("btnReset").addEventListener("click",(()=>{if(!confirm("Réinitialiser la séance (plan et résultats conservés) ?"))return;timerInterval&&(clearInterval(timerInterval),timerInterval=null),running=!1,blocIndex=0,subIndex=0,elapsed=0,subElapsed=0,subPlots=0,blocRunLog=[],applyThemeColor(0),refreshUI()})),document.getElementById("btnExportCSV").addEventListener("click",(()=>{const e=resultsToCSV(results);download("resultats_mange_plots.csv",e,"text/csv")}));function qrPayloadFiltered(e){const t="A"===e?runners.A:runners.B,n=results.filter((e=>e.nom===t.nom&&e.prenom===t.prenom&&e.classe===t.classe));return buildScanProfPayloadFromResults(n)}document.getElementById("btnQRA").addEventListener("click",(()=>{document.getElementById("qrcodes").innerHTML="";const e=document.createElement("div");document.getElementById("qrcodes").appendChild(e),makeQRCode(e,JSON.stringify(qrPayloadFiltered("A")))})),document.getElementById("btnQRB").addEventListener("click",(()=>{document.getElementById("qrcodes").innerHTML="";const e=document.createElement("div");document.getElementById("qrcodes").appendChild(e),makeQRCode(e,JSON.stringify(qrPayloadFiltered("B")))})),document.getElementById("btnQRBoth").addEventListener("click",(()=>{document.getElementById("qrcodes").innerHTML="";const e=document.createElement("div");document.getElementById("qrcodes").appendChild(e),makeQRCode(e,JSON.stringify(buildScanProfPayloadFromResults(results)))})),initBloc(),renderResults(),refreshUI();
